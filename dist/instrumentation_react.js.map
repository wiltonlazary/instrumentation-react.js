{"version":3,"sources":["../src/instrumentation_react.ts"],"names":[],"mappings":"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","file":"instrumentation_react.js","sourcesContent":["import { getPropertyDescriptorPrototype, bypassNextBinderDispatch } from 'instrumentation.js'\n\nexport function observed(params: string | Array<any> = ''): any {\n    return (target: any, propertyKey: string, descriptor: PropertyDescriptor) => {\n        const targetPrototype = target.constructor.prototype\n\n        if (!targetPrototype.__binds__) {\n            targetPrototype.__binds__ = []\n        }\n\n        targetPrototype.__binds__.push([propertyKey, descriptor, typeof params === 'string' ? [params] : params])\n    }\n}\n\nexport function reactObservedConsumer(value, detail) {\n    if (detail.content.value != detail.content.oldValue) {\n        console.log('reactObservedConsumer', detail)\n        const component = detail.binder.producer\n\n        if (!detail.carrier.onFinished) {\n            detail.carrier.onFinished = (value, result) => {\n                const __updatedSeq = component.state.__updatedSeq\n                component.state.__updatedSeq = !__updatedSeq || __updatedSeq === Number.MAX_SAFE_INTEGER ? 1 : __updatedSeq + 1\n            }\n        }\n    }\n}\n\nfunction reactStateObservedConsumer(value, detail) {\n    if (detail.content.value != detail.content.oldValue) {\n        detail.binder.producer.forceUpdate()\n    }\n\n    detail.carrier.preventDefault = true\n}\n\nexport type ReactConstructorType = { new(props): {} }\n\nexport function observer(params: string | Array<any> = '/.*'): any {\n    return (target: ReactConstructorType) => {\n        const targetPrototype = target.prototype\n        let binds: Array<any> = null\n\n        if (targetPrototype.__binds__) {\n            binds = targetPrototype.__binds__\n            delete targetPrototype.__binds__\n        } else {\n            binds = []\n        }\n\n        binds.push(['state', undefined, [typeof params === 'string' ? [params] : params, reactStateObservedConsumer]])\n\n        binds.forEach(bindParams => {\n            const key = bindParams[0]\n            const keyDescriptor = bindParams[1]\n\n            if (!keyDescriptor) {\n                const backingPropertyName = `__${key}`\n\n                Object.defineProperty(targetPrototype, key, {\n                    get: function () {\n                        return this[backingPropertyName]\n                    },\n                    set: function (value) {\n                        this[backingPropertyName] = value\n                    },\n                    enumerable: true,\n                    configurable: true\n                })\n            }\n        })\n\n        const bindOut = function (self, key: string, element: string, comsumer) {\n            if (element.length === 0) {\n                self.bindOut(key, comsumer)\n            } else if (element.startsWith('/')) {\n                self.bindOut(`${key}${element}`, comsumer)\n            } else {\n                self.bindOut(`${key}.${element}`, comsumer)\n            }\n        }\n\n        const installBinders = function (self) {\n            binds.forEach(bindParams => {\n                const key = bindParams[0]\n                const keyDescriptor = bindParams[1]\n                const keyParams = bindParams[2]\n\n                if (keyParams.length === 0) {\n                    self.bindOut(key, reactObservedConsumer)\n                } else {\n                    if (keyParams[0] instanceof Array) {\n                        keyParams[0].forEach((element: string) => {\n                            bindOut(self, key, element, keyParams[1] || reactObservedConsumer)\n                        })\n                    } else {\n                        bindOut(self, key, keyParams[0], keyParams[1] || reactObservedConsumer)\n                    }\n                }\n            })\n        }\n\n        return eval(`(class ${target.name} extends target {\n            constructor(props) {\n                super(props)\n                installBinders(this)\n            }\n\n            componentWillUnmount() {\n                if (super.componentWillUnmount) {\n                    super.componentWillUnmount()\n                }\n\n                this.dispose()\n            }\n        })`)\n    }\n}\n"]}